# ============================================================================
# docker-compose.dev.yml - Entorno de Desarrollo Local Completo
# ============================================================================
# CombinaciÃ³n optimizada de tu archivo original + mejoras
# ============================================================================
version: '3.8'

services:
  # ==========================================================================
  # DATABASE - PostgreSQL
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: musicstream-postgres
    environment:
      POSTGRES_DB: musicstream_db  # âœ… Cambiado para coincidir con tu cÃ³digo
      POSTGRES_USER: musicstreamdb # âœ… Cambiado para coincidir con tu cÃ³digo
      POSTGRES_PASSWORD: dev_password_change_in_prod
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    ports:
      - "5432:5432"
    volumes:
      # Volumen persistente
      - postgres_data:/var/lib/postgresql/data
      
      # ðŸš€ Scripts de inicializaciÃ³n (ejecutan en orden alfabÃ©tico)
      - ./init/01-create-databases.sql:/docker-entrypoint-initdb.d/01-create-databases.sql
      - ./init/02-create-tables.sql:/docker-entrypoint-initdb.d/02-create-tables.sql
      - ./init/03-seed-data.sql:/docker-entrypoint-initdb.d/03-seed-data.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U musicstreamdb -d musicstream_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - musicstream-network

  # ==========================================================================
  # CATALOG SERVICE
  # ==========================================================================
  catalog-service:
    build:
      context: ../catalog-service
      dockerfile: Dockerfile.dev
    container_name: musicstream-catalog
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      
      # Base de datos (conexiÃ³n directa, sin Cloud SQL socket)
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: musicstream_db
      DB_USER: musicstreamdb
      DB_PASSWORD: dev_password_change_in_prod
      
      # Google Cloud Storage (para desarrollo local, opcional)
      GCP_PROJECT_ID: musicstreamlite
      GCS_BUCKET: music-stream-lite-bucket
      
      # Logging
      LOG_LEVEL: debug
    volumes:
      # ðŸ”¥ Hot-reload: monta tu cÃ³digo local
      - ../catalog-service:/app:delegated
      # Excluye node_modules para evitar conflictos
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "health-check.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - musicstream-network
    command: npm run dev

  # ==========================================================================
  # USER SERVICE
  # ==========================================================================
  user-service:
    build:
      context: ../user-service
      dockerfile: Dockerfile.dev
    container_name: musicstream-user
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      
      # Base de datos
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: musicstream_db
      DB_USER: musicstreamdb
      DB_PASSWORD: dev_password_change_in_prod
      
      # JWT (usa secreto diferente en producciÃ³n)
      JWT_SECRET: dev-jwt-secret-key-change-in-production
      JWT_EXPIRES_IN: 24h
      
      # CORS
      CORS_ORIGIN: http://localhost:3000
      
      # Logging
      LOG_LEVEL: debug
    volumes:
      - ../user-service:/app:delegated
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "health-check.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - musicstream-network
    command: npm run dev

  # ==========================================================================
  # ANALYTICS SERVICE
  # ==========================================================================
  analytics-service:
    build:
      context: ../analytics-service
      dockerfile: Dockerfile.dev
    container_name: musicstream-analytics
    ports:
      - "3003:8080"  # âœ… Puerto externo:interno correcto
    environment:
      NODE_ENV: development
      PORT: 8080  # âœ… Puerto interno correcto
      
      # Firestore
      GOOGLE_CLOUD_PROJECT: musicstreamlite
      # ðŸ”¥ Usar emulador de Firestore
      FIRESTORE_EMULATOR_HOST: firestore:8080
      
      # Logging
      LOG_LEVEL: debug
    volumes:
      - ../analytics-service:/app:delegated
      - /app/node_modules
    depends_on:
      - firestore
    healthcheck:
      test: ["CMD", "node", "health-check.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - musicstream-network
    command: npm run dev

  # ==========================================================================
  # FIRESTORE EMULATOR
  # ==========================================================================
  firestore:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    container_name: musicstream-firestore
    ports:
      - "8080:8080"  # Puerto del emulador
      - "4000:4000"  # UI web del emulador
    volumes:
      # Volumen persistente para datos del emulador
      - firestore_data:/opt/data
    environment:
      FIRESTORE_PROJECT_ID: musicstreamlite
    command: >
      gcloud emulators firestore start
      --host-port=0.0.0.0:8080
      --project=musicstreamlite
    networks:
      - musicstream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # FRONTEND (COMENTADO - NO EXISTE EN ESTE REPO)
  # ==========================================================================
  # frontend:
  #   build:
  #     context: ../frontend/react-app
  #     dockerfile: Dockerfile.dev
  #   container_name: musicstream-frontend
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     REACT_APP_CATALOG_SERVICE_URL: http://localhost:3001
  #     REACT_APP_USER_SERVICE_URL: http://localhost:3002
  #     REACT_APP_ANALYTICS_SERVICE_URL: http://localhost:3003
  #     REACT_APP_ENV: development
  #     CHOKIDAR_USEPOLLING: true
  #     WATCHPACK_POLLING: true
  #   volumes:
  #     - ../frontend/react-app:/app:delegated
  #     - /app/node_modules
  #   depends_on:
  #     - catalog-service
  #     - user-service
  #     - analytics-service
  #   stdin_open: true
  #   tty: true
  #   networks:
  #     - musicstream-network

  # ==========================================================================
  # REDIS (Para cache y sesiones)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: musicstream-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - musicstream-network

  # ==========================================================================
  # PGADMIN (Para administrar PostgreSQL)
  # ==========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: musicstream-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@musicstream.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - musicstream-network  # âœ… Corregido el typo
    profiles:
      - tools  # Solo se levanta con: docker-compose --profile tools up

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
    name: musicstream-postgres-data
  firestore_data:
    name: musicstream-firestore-data
  redis_data:
    name: musicstream-redis-data
  pgadmin_data:
    name: musicstream-pgadmin-data

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  musicstream-network:
    driver: bridge
    name: musicstream-dev-network