# .github/workflows/deploy-analytics.yml
name: ğŸš€ Deploy Analytics Service

on:
  push:
    branches: 
      - main
    paths:
      - 'analytics-service/**'
      - '.github/workflows/deploy-analytics.yml'

env:
  PROJECT_ID: musicstreamlite
  SERVICE_NAME: analytics-service
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev
  SERVICE_ACCOUNT: analytics-service@musicstreamlite.iam.gserviceaccount.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # 2. Auth to GCP with Service Account Key
      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      # 3. Setup gcloud CLI
      - name: ğŸ”§ Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: 'gke-gcloud-auth-plugin'
      
      # 4. Configure Docker for Google Artifact Registry
      - name: ğŸ³ Configure Docker for GAR
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}
      
      # 5. Build Docker image
      - name: ğŸ—ï¸ Build Docker image
        working-directory: ./analytics-service
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:latest \
            .
      
      # 6. Push to Google Artifact Registry
      - name: ğŸ“¤ Push to Google Artifact Registry
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:latest
      
      # 7. Deploy to Cloud Run WITH SERVICE ACCOUNT
      - name: ğŸš€ Deploy to Google Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --timeout=300s \
            --service-account=${{ env.SERVICE_ACCOUNT }} \
            --set-env-vars="FIRESTORE_PROJECT_ID=${{ env.PROJECT_ID }},NODE_ENV=production" \
            --project=${{ env.PROJECT_ID }}
      
      # 8. Get service URL
      - name: ğŸ“ Get service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)' \
            --project=${{ env.PROJECT_ID }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ğŸ”— Service URL: $URL"
      
      # 9. Wait for service to be ready
      - name: â³ Wait for service to be ready
        run: |
          sleep 15
          SERVICE_URL="${{ steps.service-url.outputs.url }}"
          echo "Waiting for service to stabilize..."
      
      # 10. Health check
      - name: âœ… Health check
        run: |
          SERVICE_URL="${{ steps.service-url.outputs.url }}"
          echo "Checking health at: $SERVICE_URL/health"
          
          # Retry logic: intentar 5 veces
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f "$SERVICE_URL/health"; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            if [ $i -lt 5 ]; then
              echo "â³ Retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          echo "âŒ Health check failed after 5 attempts"
          exit 1
      
      # 11. Success notification
      - name: ğŸ‰ Deployment successful
        run: |
          echo "âœ… Analytics Service deployed successfully"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "  ğŸ“ Region: ${{ env.REGION }}"
          echo "  ğŸ”— URL: ${{ steps.service-url.outputs.url }}"
          echo "  ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/musicstreamlite/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "  ğŸ‘¤ Service Account: ${{ env.SERVICE_ACCOUNT }}"
          echo "  ğŸ” Project: ${{ env.PROJECT_ID }}"
          echo ""
          echo "ğŸš€ Ready to use!"
      
      # 12. On failure, show logs
      - name: ğŸ“‹ Show logs on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed. Showing recent logs..."
          gcloud logging read \
            "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --limit=20 \
            --format='value(textPayload)' \
            --project=${{ env.PROJECT_ID }} \
            --freshness=10m || true